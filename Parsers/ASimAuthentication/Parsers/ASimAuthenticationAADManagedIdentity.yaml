Parser:
  Title: Authentication ASIM parser for Microsoft AAD managed identity authentication
  Version: '0.1.0'
  LastUpdated: June 17, 2021
Product:
  Name: Microsoft AAD (managed identity signin logs)
Normalization:
  Schema: Authentication
  Version: 0.1.0'
References:
- Title: ASIM Authentication Schema
  Link: https://aka.ms/ASimAuthenticationDoc
- Title: ASIM
  Link: https://aka.ms/AboutASIM
Description: |
  This ASIM parser supports normalizing Microsoft AAD managed identity authentication logs, produced by the Microsoft AAD connector, to the ASIM Authentication normalized schema.
ParserName: ASimAuthenticationAADManagedIdentitySignInLogs
ParserParams:
  - Name: disabled
    Type: bool
    Default: false
ParserQuery: |
  let AADMIAuthentication=(disabled:bool=false){
    AADManagedIdentitySignInLogs | where not(disabled)
    | extend
        EventVendor = 'Microsoft'
        , EventProduct = 'AAD'
        , EventCount=int(1)
        , EventSchemaVersion='0.1.0'
        , EventResult = iff (ResultType ==0, 'Success', 'Failure')
        //, EventOriginalResultDetails = ResultType
        , EventOriginalResultDetails = coalesce(ResultDescription, ResultType)
        , EventStartTime = TimeGenerated
        , EventEndTime= TimeGenerated
        , EventType= 'Logon'
        , Location = todynamic(LocationDetails)
        , TargetAppId = ResourceIdentity 
        , TargetAppName=ResourceDisplayName
        , TargetUserType='ServicePrincipal'
        , TargetUsername=ServicePrincipalName
        , TargetUserId=ServicePrincipalId
        , TargetUsernameType='Simple'
        , TargetUserIdType='AADID'
    | extend
        SrcGeoCity=tostring(Location.city)
        , SrcGeoCountry=tostring(Location.countryOrRegion)
        , SrcGeoLatitude=toreal(Location.geoCoordinates.latitude)
        , SrcGeoLongitude=toreal(Location.geoCoordinates.longitude)
    | project-rename
        EventOriginalUid = Id
        , TargetSessionId = CorrelationId
        , SrcDvcIpAddr = IPAddress
    | project-reorder
        TimeGenerated
        ,EventProduct
        , EventOriginalUid
        , EventResult
        //, EventOriginalResultDetails 
        , EventOriginalResultDetails
        , EventStartTime
        , EventEndTime
        , TargetSessionId
        , SrcGeoCountry
        , SrcGeoCity
        , TargetAppName
        , TargetAppId
        | lookup AADSTSErrorCodes on ResultType
        // ** Aliases
        | extend 
          User=TargetUsername
        , LogonTarget=ResourceIdentity
        , Dvc=EventVendor
        };
  AADMIAuthentication(disabled)