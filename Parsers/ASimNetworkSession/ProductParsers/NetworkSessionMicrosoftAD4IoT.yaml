Parser:
  Title: ASIM Azure Defender for IoT Network Sessions Parser
  Version: '0.0'
  LastUpdated: Aug 4, 2021
Product:
  Name: Azure Defender for IoT
Normalization:
  Schema: NetworkSessions
  Version: '0.2.0'
References:
- Title: ASIM Network Session Schema
  Link: https://aka.ms/AzSentinelNetworkSessionDoc
- Title: ASIM
  Link: https:/aka.ms/AzSentinelNormalization
Description: |
  ASIM Azure Defender for IoT Network Sessions Parser.
ParserName: vimNetworkSessionAD4IoT
ParserQuery: |
  let NetworkSessionAD4IoT=(){
  // -- Common preprocessing to both input and outbound events
  
  let RawNetworkEvents =
    SecurityIoTRawEvent 
    | where RawEventName == "NetworkActivity"
    | extend
      EventDetails = todynamic(EventDetails) // -- waiting for schema fix
     // Event
      EventOriginalUid = EventDetails.EventId, // OK pending question
      EventCount = int(1), // OK
      EventProduct = 'Azure Defender for IoT', // OK 
      EventVendor = 'Microsoft', // OK
      EventSchemaVersion = '0.1.0', // OK
      EventType = 'NetworkSession', // OK
      EventStartTime = todatetime(TimeGenerated), // Open question about timestamps
      EventEndTime = todatetime(TimeGenerated), // Open question about timestamps
      EventType = 'NetworkSession', // OK
      EventResult = 'Success', // OK
      DvcOs = EventDetails.MessageSource, // OK
      NetworkProtocol = EventDetails.Protocol // OK
    | project-rename
      DvcId = DeviceId, // OK
    | extend
      Dvc = DvcId // OK
  ;
  let OutboundNetworkEvents = 
    RawNetworkEvents
    ###| where Outbound
    | extend
       SrcBytes = BytesOut, // OK
       DstBytes = BytesIn, // OK
       SrcIpAddr = LocalAddress, // OK
       SrcPortNumber = LocalPort, // OK
       DstIpAddr = RemoveAddress, // OK
       DstPortNumber = RemotePort // OK
       SrrDvcId = Dvc,
       SrcDvcIdType = "AD4IoTid"
  ;
  let InboundNetworkEvents = 
    RawNetworkEvents
    ###| where Inbound
    | extend
       DstBytes = BytesOut, // OK
       SrcBytes = BytesIn, // OK
       DstIpAddr = LocalAddress, // OK
       DstPortNumber = LocalPort, // OK
       SrcIpAddr = RemoveAddress, // OK
       SrcPortNumber = RemotePort // OK
       DstDvcId = Dvc,
       DstDvcIdType = "AD4IoTid"
  ;
  union (InboundNetworkEvents, OutboundNetworkEvents)
  };
  NetworkSessionAD4IoT

